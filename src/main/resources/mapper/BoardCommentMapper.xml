<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tripboard.mapper.BoardCommentMapper">
    
    <resultMap id="BoardCommentResultMap" type="com.tripboard.entity.BoardComment">
        <id property="commentId" column="comment_id"/>
        <result property="parentCommentId" column="parent_comment_id"/>
        <result property="postId" column="post_id"/>
        <result property="commentOrder" column="comment_order"/>
        <result property="userId" column="user_id"/>
        <result property="content" column="content"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="authorNickname" column="author_nickname"/>
        <result property="authorName" column="author_name"/>
        <result property="authorProfileImage" column="author_profile_image"/>
    </resultMap>
    
    <select id="findByPostId" resultMap="BoardCommentResultMap">
        SELECT bc.*, 
               COALESCE(u.nickname, u.name) as author_nickname,
               u.name as author_name,
               u.profile_image as author_profile_image
        FROM board_comments bc
        LEFT JOIN users u ON bc.user_id = u.user_id
        WHERE bc.post_id = #{postId} AND bc.parent_comment_id IS NULL
        ORDER BY bc.created_at ASC
    </select>
    
    <select id="findById" resultMap="BoardCommentResultMap">
        SELECT bc.*, 
               COALESCE(u.nickname, u.name) as author_nickname,
               u.name as author_name,
               u.profile_image as author_profile_image
        FROM board_comments bc
        LEFT JOIN users u ON bc.user_id = u.user_id
        WHERE bc.comment_id = #{commentId}
    </select>
    
    <select id="findByParentCommentId" resultMap="BoardCommentResultMap">
        SELECT bc.*, 
               COALESCE(u.nickname, u.name) as author_nickname,
               u.name as author_name,
               u.profile_image as author_profile_image
        FROM board_comments bc
        LEFT JOIN users u ON bc.user_id = u.user_id
        WHERE bc.parent_comment_id = #{parentCommentId}
        ORDER BY bc.created_at ASC
    </select>
    
    <select id="countByPostId" resultType="int">
        SELECT COUNT(*) FROM board_comments WHERE post_id = #{postId}
    </select>
    
    <insert id="insert" useGeneratedKeys="true" keyProperty="commentId">
        INSERT INTO board_comments (parent_comment_id, post_id, comment_order, user_id, content, created_at, updated_at)
        VALUES (#{parentCommentId}, #{postId}, #{commentOrder}, #{userId}, #{content}, #{createdAt}, #{updatedAt})
    </insert>
    
    <update id="update">
        UPDATE board_comments
        SET content = #{content},
            updated_at = #{updatedAt}
        WHERE comment_id = #{commentId}
    </update>
    
    <delete id="delete">
        DELETE FROM board_comments WHERE comment_id = #{commentId}
    </delete>
    
</mapper>
